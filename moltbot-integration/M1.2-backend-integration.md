# M1.2: Container Deployment Backend (Railway)

> **Sprint**: M1.2  
> **Status**: ğŸ¯ In Progress  
> **Goal**: Create API endpoints to deploy and manage Moltbot containers on Railway
> **Duration**: 2-3 days

---

## ğŸ“‹ Sub-Sprint Breakdown

| Sprint | Goal | Duration | Status |
|--------|------|----------|--------|
| M1.2.1 | Railway API Research & Setup | 2 hours | ğŸ¯ Current |
| M1.2.2 | Database Schema | 1 hour | ğŸ”œ Next |
| M1.2.3 | Deploy Endpoint | 3-4 hours | ğŸ”œ Planned |
| M1.2.4 | Status & Management Endpoints | 2-3 hours | ğŸ”œ Planned |
| M1.2.5 | Secrets Encryption Module | 2 hours | ğŸ”œ Planned |
| M1.2.6 | Integration Testing | 2-3 hours | ğŸ”œ Planned |

---

## M1.2.1: Railway API Research & Setup

### Objective
Understand Railway's GraphQL API and set up authentication.

### Railway API Overview

**Endpoint**: `https://backboard.railway.app/graphql/v2`

**Authentication**: Bearer token (API key from Railway dashboard)

**Key Concepts**:
- **Project**: Top-level container for services
- **Environment**: Production/staging within a project
- **Service**: Individual deployed application
- **Deployment**: Instance of a service running
- **Variables**: Environment variables for a service

### API Operations Needed

| Operation | GraphQL Mutation/Query | Purpose |
|-----------|------------------------|---------|
| Create Service | `serviceCreate` | Deploy new Moltbot instance |
| Get Service | `service` | Check deployment status |
| List Deployments | `deployments` | Monitor deployment progress |
| Set Variables | `variableCollectionUpsert` | Inject API keys/tokens |
| Redeploy | `deploymentRedeploy` | Restart instance |
| Delete Service | `serviceDelete` | Terminate instance |

### Tasks

- [ ] Get Railway API token from dashboard
- [ ] Test basic GraphQL query (list projects)
- [ ] Document required mutations
- [ ] Create Railway API client module

### Success Metrics

| Metric | Target |
|--------|--------|
| API token obtained | âœ“ |
| Can list projects | âœ“ |
| Can create test service | âœ“ |
| Understand variable injection | âœ“ |

---

## M1.2.2: Database Schema

### Objective
Create tables to track Moltbot instances and their secrets.

### Schema Design

```sql
-- Moltbot instances table
CREATE TABLE moltbot_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  name TEXT NOT NULL,
  
  -- Railway identifiers
  railway_project_id TEXT,
  railway_service_id TEXT,
  railway_environment_id TEXT,
  railway_deployment_id TEXT,
  
  -- Connection info
  railway_url TEXT,
  
  -- Configuration
  ai_provider TEXT NOT NULL CHECK (ai_provider IN ('anthropic', 'openai')),
  channels TEXT[] DEFAULT '{}',
  
  -- Status
  status TEXT DEFAULT 'pending' CHECK (status IN (
    'pending', 'deploying', 'building', 'running', 'stopped', 'failed', 'terminated'
  )),
  
  -- Billing
  subscription_id TEXT,
  subscription_status TEXT DEFAULT 'trialing',
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  deployed_at TIMESTAMPTZ,
  stopped_at TIMESTAMPTZ,
  terminated_at TIMESTAMPTZ,
  
  -- Usage tracking
  total_uptime_seconds INTEGER DEFAULT 0,
  last_health_check TIMESTAMPTZ
);

-- Encrypted secrets for each instance
CREATE TABLE moltbot_secrets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id UUID NOT NULL REFERENCES moltbot_instances(id) ON DELETE CASCADE,
  
  -- Secret identification
  key_name TEXT NOT NULL,  -- e.g., 'ANTHROPIC_API_KEY'
  
  -- Encrypted value (AES-256-GCM)
  encrypted_value TEXT NOT NULL,
  iv TEXT NOT NULL,  -- Initialization vector
  auth_tag TEXT NOT NULL,  -- Authentication tag
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(instance_id, key_name)
);

-- Indexes
CREATE INDEX idx_moltbot_instances_user_id ON moltbot_instances(user_id);
CREATE INDEX idx_moltbot_instances_status ON moltbot_instances(status);
CREATE INDEX idx_moltbot_secrets_instance_id ON moltbot_secrets(instance_id);
```

### Tasks

- [ ] Create migration file
- [ ] Run migration on Supabase
- [ ] Test insert/select operations
- [ ] Verify cascade delete works

### Success Metrics

| Metric | Target |
|--------|--------|
| Tables created | âœ“ |
| Indexes created | âœ“ |
| Insert test passes | âœ“ |
| Cascade delete works | âœ“ |

---

## M1.2.3: Deploy Endpoint

### Objective
Create `POST /api/moltbot/deploy` to provision Moltbot on Railway.

### Endpoint Design

```
POST /api/moltbot/deploy

Headers:
  x-privy-id: user-abc123

Body:
{
  "name": "my-moltbot",
  "aiProvider": "anthropic",
  "aiApiKey": "sk-ant-xxx",
  "channels": {
    "telegram": {
      "botToken": "123456:ABC-xxx"
    }
  }
}

Response (201 Created):
{
  "success": true,
  "instance": {
    "id": "mb-uuid",
    "name": "my-moltbot",
    "status": "deploying",
    "aiProvider": "anthropic",
    "channels": ["telegram"],
    "estimatedReadyTime": "5-10 minutes",
    "createdAt": "2026-01-31T12:00:00Z"
  }
}

Error Response (400/500):
{
  "success": false,
  "error": "Invalid API key format",
  "code": "INVALID_API_KEY"
}
```

### Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEPLOY FLOW                                                â”‚
â”‚                                                             â”‚
â”‚  1. Validate request body                                   â”‚
â”‚     â”œâ”€ Check required fields                                â”‚
â”‚     â”œâ”€ Validate API key format                              â”‚
â”‚     â””â”€ Check user subscription                              â”‚
â”‚                                                             â”‚
â”‚  2. Create database record (status: pending)                â”‚
â”‚                                                             â”‚
â”‚  3. Encrypt and store secrets                               â”‚
â”‚     â”œâ”€ ANTHROPIC_API_KEY or OPENAI_API_KEY                  â”‚
â”‚     â””â”€ TELEGRAM_BOT_TOKEN, DISCORD_BOT_TOKEN, etc.          â”‚
â”‚                                                             â”‚
â”‚  4. Create Railway service                                  â”‚
â”‚     â”œâ”€ serviceCreate mutation                               â”‚
â”‚     â”œâ”€ Set source (GitHub repo or Docker)                   â”‚
â”‚     â””â”€ Configure build settings                             â”‚
â”‚                                                             â”‚
â”‚  5. Inject environment variables                            â”‚
â”‚     â”œâ”€ variableCollectionUpsert mutation                    â”‚
â”‚     â””â”€ Include decrypted secrets + system vars              â”‚
â”‚                                                             â”‚
â”‚  6. Update database (status: deploying)                     â”‚
â”‚                                                             â”‚
â”‚  7. Return instance details                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tasks

- [ ] Create route file `backend/src/routes/moltbot.js`
- [ ] Implement validation middleware
- [ ] Implement Railway service creation
- [ ] Implement variable injection
- [ ] Update database on success
- [ ] Handle errors gracefully

### Success Metrics

| Metric | Target |
|--------|--------|
| Validation catches bad input | âœ“ |
| Railway service created | âœ“ |
| Variables injected | âœ“ |
| Database record created | âœ“ |
| Returns correct response | âœ“ |

---

## M1.2.4: Status & Management Endpoints

### Objective
Create endpoints to check status and manage Moltbot instances.

### Endpoints

#### GET /api/moltbot/instances
List all user's Moltbot instances.

```
Response:
{
  "instances": [
    {
      "id": "mb-uuid",
      "name": "my-moltbot",
      "status": "running",
      "aiProvider": "anthropic",
      "channels": ["telegram"],
      "url": "https://my-moltbot.up.railway.app",
      "uptime": "2d 14h 23m",
      "createdAt": "2026-01-29T10:00:00Z"
    }
  ]
}
```

#### GET /api/moltbot/instances/:id
Get single instance details.

#### POST /api/moltbot/instances/:id/restart
Redeploy/restart an instance.

#### DELETE /api/moltbot/instances/:id
Terminate and delete an instance.

### Tasks

- [ ] Implement list instances endpoint
- [ ] Implement get instance endpoint
- [ ] Implement restart endpoint (Railway redeploy)
- [ ] Implement terminate endpoint (Railway delete + DB cleanup)
- [ ] Add polling for deployment status

### Success Metrics

| Metric | Target |
|--------|--------|
| List returns user's instances | âœ“ |
| Status reflects Railway state | âœ“ |
| Restart triggers redeploy | âœ“ |
| Terminate cleans up everything | âœ“ |

---

## M1.2.5: Secrets Encryption Module

### Objective
Securely encrypt and store user API keys.

### Encryption Design

```javascript
// AES-256-GCM encryption
// - 256-bit key from MOLTBOT_ENCRYPTION_KEY env var
// - Random 12-byte IV per encryption
// - 128-bit auth tag for integrity

const encrypt = (plaintext, key) => {
  const iv = crypto.randomBytes(12)
  const cipher = crypto.createCipheriv('aes-256-gcm', key, iv)
  const encrypted = Buffer.concat([cipher.update(plaintext), cipher.final()])
  const authTag = cipher.getAuthTag()
  return { encrypted, iv, authTag }
}

const decrypt = (encrypted, iv, authTag, key) => {
  const decipher = crypto.createDecipheriv('aes-256-gcm', key, iv)
  decipher.setAuthTag(authTag)
  return Buffer.concat([decipher.update(encrypted), decipher.final()]).toString()
}
```

### Security Requirements

- âœ— Never log plaintext secrets
- âœ— Never return secrets in API responses
- âœ— Never store key in database
- âœ“ Key stored in environment variable only
- âœ“ Each secret has unique IV
- âœ“ Auth tag prevents tampering

### Tasks

- [ ] Create encryption utility module
- [ ] Add MOLTBOT_ENCRYPTION_KEY to env
- [ ] Implement storeSecret function
- [ ] Implement getSecrets function (for Railway injection)
- [ ] Add tests for encrypt/decrypt

### Success Metrics

| Metric | Target |
|--------|--------|
| Encryption works | âœ“ |
| Decryption works | âœ“ |
| No plaintext in DB | âœ“ |
| No plaintext in logs | âœ“ |

---

## M1.2.6: Integration Testing

### Objective
End-to-end testing of the deployment flow.

### Test Scenarios

| Test | Expected Result |
|------|-----------------|
| Deploy with valid data | Instance created, status: deploying |
| Deploy with invalid API key | 400 error, INVALID_API_KEY |
| Deploy without subscription | 402 error, SUBSCRIPTION_REQUIRED |
| Get non-existent instance | 404 error |
| Restart running instance | Redeploy triggered |
| Terminate instance | Service deleted, DB cleaned |
| List instances (no instances) | Empty array |
| List instances (with instances) | Array of instances |

### Tasks

- [ ] Write integration tests
- [ ] Test Railway API mocking
- [ ] Test full flow with real Railway (manual)
- [ ] Document any edge cases

### Success Metrics

| Metric | Target |
|--------|--------|
| All tests pass | âœ“ |
| Coverage > 80% | âœ“ |
| Manual deploy works | âœ“ |

---

## ğŸ“ Files to Create

| File | Purpose |
|------|---------|
| `backend/src/routes/moltbot.js` | API routes |
| `backend/src/providers/railway.js` | Railway API client |
| `backend/src/utils/encryption.js` | Secrets encryption |
| `backend/src/db/moltbot-schema.sql` | Database schema |

---

*Last updated: January 31, 2026*
