# M1.1: Docker Validation & Resource Profiling

> **Sprint**: M1.1  
> **Status**: ğŸ¯ In Progress  
> **Goal**: Validate Moltbot container deployment, measure real resource usage

---

## ğŸ” Key Finding: No Public Docker Image

After analyzing the Moltbot repository:

| Check | Result |
|-------|--------|
| Official Docker image on ghcr.io | âŒ Not found |
| Official Docker image on Docker Hub | âŒ Not found |
| Dockerfile in repo | âœ… Yes |
| docker-compose.yml | âœ… Yes |
| fly.toml (Fly.io config) | âœ… Yes |

**Implication**: Moltbot builds from source during deployment. We need to:
1. Build our own Docker image
2. Push to a registry (Docker Hub or GHCR)
3. Reference that image in RunPod deployments

---

## ğŸ“¦ Official Dockerfile Analysis

```dockerfile
FROM node:22-bookworm

# Install Bun (required for build scripts)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

RUN corepack enable

WORKDIR /app

# Optional apt packages
ARG CLAWDBOT_DOCKER_APT_PACKAGES=""
RUN if [ -n "$CLAWDBOT_DOCKER_APT_PACKAGES" ]; then ...

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

RUN pnpm install --frozen-lockfile

COPY . .
RUN CLAWDBOT_A2UI_SKIP_MISSING=1 pnpm build
ENV CLAWDBOT_PREFER_PNPM=1
RUN pnpm ui:install
RUN pnpm ui:build

ENV NODE_ENV=production
USER node

CMD ["node", "dist/index.js"]
```

### Resource Requirements (from fly.toml)

| Resource | Value | Notes |
|----------|-------|-------|
| **CPU** | shared-cpu-2x | 2 shared vCPUs |
| **RAM** | 2048 MB | 2GB minimum |
| **Storage** | Volume mount | Persistent /data |
| **Node.js** | 22+ | Non-negotiable |
| **Build time** | ~5-10 min | pnpm install + build |
| **Image size** | ~1.5-2 GB | Node.js + dependencies |

---

## ğŸ—ï¸ Primis Image Strategy

### Option A: Build on Primis Infrastructure (Recommended)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIMIS MOLTBOT IMAGE PIPELINE                              â”‚
â”‚                                                             â”‚
â”‚  1. GitHub Actions watches Moltbot releases                 â”‚
â”‚  2. On new release â†’ Build Docker image                     â”‚
â”‚  3. Push to ghcr.io/primisprotocol/moltbot:latest          â”‚
â”‚  4. Tag with version: ghcr.io/primisprotocol/moltbot:2026.1â”‚
â”‚  5. User deploys â†’ Pulls from our registry                  â”‚
â”‚                                                             â”‚
â”‚  Benefits:                                                  â”‚
â”‚  âœ“ We control the image                                     â”‚
â”‚  âœ“ Can add Primis-specific optimizations                    â”‚
â”‚  âœ“ Consistent experience for users                          â”‚
â”‚  âœ“ No dependency on Moltbot team                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Option B: Partner with Moltbot Team

- Request they publish official images to ghcr.io
- Lower maintenance for us
- Dependent on their release schedule

**Decision**: Go with Option A for now (self-hosted image)

---

## ğŸ’° Hosting Cost Analysis

### RunPod CPU Pod (Recommended)

| Configuration | Cost | Notes |
|---------------|------|-------|
| 2 vCPU + 4GB RAM | ~$0.01/hr | $7.20/month |
| 4 vCPU + 8GB RAM | ~$0.02/hr | $14.40/month |
| + 10GB SSD | ~$1/month | Persistent storage |

**Total estimate**: ~$8-15/month per Moltbot instance

**Pricing at $30/mo**: **~50-60% gross margin**

### Fly.io Comparison

| Configuration | Cost | Notes |
|---------------|------|-------|
| shared-cpu-2x + 2GB | ~$0.02/hr | $14/month |
| + 1GB volume | ~$0.15/month | |

**Total**: ~$15-20/month per instance

### Lambda Labs (Not Suitable)

Lambda doesn't offer CPU-only instances. GPU minimum is ~$0.50/hr.

---

## ğŸ§ª Test Plan

### Step 1: Build Docker Image
```bash
# Clone Moltbot repo
git clone https://github.com/moltbot/moltbot.git
cd moltbot

# Build image
docker build -t primis-moltbot:test .

# Test locally
docker run -d \
  -e ANTHROPIC_API_KEY=sk-ant-xxx \
  -e TELEGRAM_BOT_TOKEN=123:abc \
  -p 18789:18789 \
  -v $(pwd)/data:/home/node/.clawdbot \
  primis-moltbot:test \
  node dist/index.js gateway --bind lan --port 18789
```

### Step 2: Push to Registry
```bash
# Login to Docker Hub (or GHCR)
docker login

# Tag for registry
docker tag primis-moltbot:test primisprotocol/moltbot:latest

# Push
docker push primisprotocol/moltbot:latest
```

### Step 3: Deploy to RunPod
```javascript
// RunPod API call (CPU pod)
const pod = await runpodQuery(`
  mutation {
    podFindAndDeployOnDemand(input: {
      name: "moltbot-test"
      imageName: "primisprotocol/moltbot:latest"
      gpuCount: 0
      containerDiskInGb: 10
      volumeInGb: 5
      volumeMountPath: "/data"
      env: [
        { key: "ANTHROPIC_API_KEY", value: "sk-ant-xxx" }
        { key: "TELEGRAM_BOT_TOKEN", value: "123:abc" }
        { key: "CLAWDBOT_STATE_DIR", value: "/data" }
        { key: "NODE_OPTIONS", value: "--max-old-space-size=1536" }
      ]
      cloudType: "SECURE"
      supportPublicIp: true
    }) {
      id
      name
      runtime { ports { ip publicPort privatePort } }
    }
  }
`)
```

### Step 4: Measure Resources
```bash
# Once running, measure:
docker stats moltbot-test

# Expected:
# - Idle RAM: ~400-600 MB
# - Active RAM: ~800-1500 MB
# - CPU (idle): ~1-2%
# - CPU (active): ~10-30%
```

---

## âš ï¸ Blockers & Risks

| Risk | Mitigation |
|------|------------|
| RunPod may not support CPU-only pods | Verify via API; fallback to cheapest GPU if needed |
| Image build may fail on ARM | Use x86 runners only |
| Moltbot updates may break | Pin to specific version; test before updating |
| Registry costs | Docker Hub free tier (1 private repo) or GHCR (free for public) |

---

## âœ… Success Criteria

| Metric | Target | How to Measure |
|--------|--------|----------------|
| Image builds | âœ“ | `docker build` completes |
| Image size | < 2.5 GB | `docker images` |
| Container starts | < 60s | Time from `docker run` to logs showing "Gateway ready" |
| Bot responds | < 5s | Send Telegram message, measure response |
| RAM (idle) | < 800 MB | `docker stats` |
| RAM (active) | < 2 GB | `docker stats` during conversation |
| 24h uptime | 100% | No crashes during test period |

---

## ğŸ“‹ Next Steps

1. **Build Docker image** (requires Docker - not available in this environment)
2. **Set up GitHub Actions** for automated builds
3. **Push to registry**
4. **Test RunPod CPU pod deployment**
5. **Measure and document real metrics**

---

## ğŸ¢ Hosting Provider Comparison

Since Moltbot is **CPU-only** (no GPU needed), we have multiple hosting options:

### Option 1: Railway (Recommended for MVP)

**Why**: We already use Railway for the Primis backend. Easy to integrate.

| Factor | Value |
|--------|-------|
| **CPU** | 2 vCPU shared |
| **RAM** | 2GB |
| **Storage** | Volume mount |
| **Cost** | ~$10-15/mo per instance |
| **Dockerfile** | âœ… Supported (builds from source) |
| **API** | âœ… Yes (for automation) |
| **Integration** | Easy (same infra as backend) |

**Deployment:**
```bash
# Railway CLI
railway up --dockerfile Dockerfile
```

**Pros:**
- Already familiar infrastructure
- Dockerfile support (no pre-built image needed)
- Simple pricing
- Good for MVP/beta

**Cons:**
- Less control than RunPod
- No GPU fallback option

---

### Option 2: RunPod (GPU Pods)

RunPod doesn't officially support CPU-only pods for on-demand containers. We must rent the **cheapest GPU** even though Moltbot doesn't need it.

| Configuration | Cost | Notes |
|---------------|------|-------|
| RTX 3070 (8GB VRAM) | ~$0.14/hr | **$101/mo** - Overkill! |
| RTX A2000 (6GB VRAM) | ~$0.15/hr | $108/mo |

**Verdict**: Too expensive for CPU-only workload. Not recommended for Moltbot.

---

### Option 3: Fly.io

| Factor | Value |
|--------|-------|
| **Config** | shared-cpu-2x + 2GB |
| **Cost** | ~$14-20/mo |
| **Dockerfile** | âœ… Supported |
| **Global** | âœ… Edge regions |

**Pros:**
- Moltbot already has `fly.toml` 
- Global edge deployment
- Good for production

**Cons:**
- Another vendor to manage
- Separate from Primis infra

---

### Option 4: Render

| Factor | Value |
|--------|-------|
| **Cost** | ~$7-25/mo |
| **Dockerfile** | âœ… Supported |
| **Integration** | Medium |

---

## ğŸ“Š Hosting Decision Matrix

| Provider | Cost/mo | Dockerfile | API | Existing Infra | Recommendation |
|----------|---------|------------|-----|----------------|----------------|
| **Railway** | $10-15 | âœ… | âœ… | âœ… Yes | **MVP** |
| Fly.io | $14-20 | âœ… | âœ… | âŒ No | Production |
| RunPod | $100+ | âœ… | âœ… | âœ… Yes | âŒ Too expensive |
| Render | $7-25 | âœ… | âœ… | âŒ No | Backup option |

**Decision**: Use **Railway** for MVP. Switch to Fly.io or dedicated infra at scale.

---

## ğŸš€ Revised M1.1 Plan

Given that Railway is our best option for MVP, here's the updated plan:

### Phase 1: Railway Deployment Test (This Sprint)

1. **Fork Moltbot repo** (or create template)
2. **Deploy to Railway** from Dockerfile
3. **Configure env vars** (test bot tokens)
4. **Measure resources** (Railway dashboard)
5. **Document startup time and stability**

### Phase 2: Automation (M1.2)

1. **Create Railway template** for 1-click deploy
2. **Build backend API** to provision Railway services
3. **Secrets management** integration

---

## ğŸ“ Files Created

| File | Purpose |
|------|---------|
| `moltbot-integration/M1.1-docker-validation.md` | This document |
| `moltbot-integration/github-actions/build-moltbot-image.yml` | GH Actions for Docker builds |
| `backend/scripts/test-moltbot-deploy.js` | RunPod test script (for reference) |

---

*Last updated: January 31, 2026*
